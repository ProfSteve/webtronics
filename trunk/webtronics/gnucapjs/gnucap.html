<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Emscripten-Generated Code</title>
    <style>
      #gnucap_scope_display_div{
      
	background-color:#ffffff;
	overflow:hidden;
	width:320px;
	height:240px;
      }
      #statusElement{
      border-width:0;
      padding:0;
	width:100%;
	height:100%;
      }
    </style>
    </head>
  <body bgcolor="white" >
  <div id="gnucap_scope_display_div" >Downloading...</div>
    <script type='text/javascript'>
  var graph={
  parsegnucap:function(t){
  console.log(t);
  var points = [];
      try{
        var text = t.split(/#Time.*\n/)[1];
        var samples=text.split('\n');
        }
        catch(e){
        //graph.printerr(t);
        return;
        }
    var k=0;
    for(var i=0;i<samples.length;i++){
// if first character is not a digit skip this line
      //if(samples[i].match(/^\s*\d/)==null)continue;
      var s = samples[i].match(/\S+/g);
      if(s!=null){
        points[k]=[];
        for(var j=0;j<s.length;j++){
//convert micro
          if(s[j][s[j].length-1]=='u'){
            s[j].replace('u','');
            s[j]=parseFloat(s[j])*0.000001;
          }
//convert nano
          if(s[j][s[j].length-1]=='n'){
            s[j].replace('n','');
            s[j]=parseFloat(s[j])*0.000000001;
          }
//convert pico
          if(s[j][s[j].length-1]=='p'){
            s[j].replace('p','');
            s[j]=parseFloat(s[j])*0.000000000001;
          }
//convert femto
          if(s[j][s[j].length-1]=='f'){
            s[j].replace('f','');
            s[j]=parseFloat(s[j])*0.00000000000001;
          }
          points[k][j]=parseFloat(s[j]);
        }
      }
      k++;
    }
    var svgNamespace = 'http://www.w3.org/2000/svg';
    colors=["red","blue","green","gold","hotpink","orange"];
    var width=320;
    var height=220;
    var graphG=document.createElementNS(svgNamespace, 'g');
   
    var min=points[0][1];
    var max=points[0][1];
  //calculate max and min height
    for(var i=0;i<points.length;i++){
      for(var j=1;j < points[i].length;j++){
        min=Math.min(min,points[i][j]);
        max=Math.max(max,points[i][j]);
      }
    }
    if(isNaN(min)||isNaN(max))return;
    var hsize=width/points.length;
    var vsize=height/(max-min);
    for(var sample=1;sample<points[0].length;sample++){
      path=document.createElementNS(svgNamespace, "path");
      var line="";
      for(var time=0;time<points.length;time++){
        var x=parseInt(hsize*time);
        var y =parseInt(vsize * (max-points[time][sample]));
        if(isNaN(x)||isNaN(y)){
          console.log(samples[time]);
        }
        if(time==0){
          line += " M0 "+ y;
        }
        else{
          line += " L" + x + " " + y;
        }
      }
      path.setAttributeNS(null,"d",line);              
      path.setAttributeNS(null,"stroke",colors[sample-1]);
      path.setAttributeNS(null,"stroke-width",1);
      path.setAttributeNS(null,"fill","none");
      graphG.appendChild(path);
    }  
    var svgRoot=document.createElementNS(svgNamespace, "svg");
    svgRoot.setAttribute("xmlns",svgNamespace);
    svgRoot.setAttributeNS(null, 'width',width);
    svgRoot.setAttributeNS(null, 'height',height+20);
    svgRoot.appendChild(graph.createtext("min="+min+" max="+max+" time="+points[points.length-1][0],"black",10,svgRoot.getAttribute('height')));  
    svgRoot.appendChild(graphG);
    return svgRoot;
  },
  createtext:function(str,color,x,y){
          var svgNamespace = 'http://www.w3.org/2000/svg';
          var svg;

          svg = document.createElementNS(svgNamespace, 'text');
          svg.setAttributeNS(null, 'x', x);
          svg.setAttributeNS(null, 'y', y);
          svg.setAttributeNS(null, 'font-size', 12);
          svg.setAttributeNS(null, 'fill', color);
          svg.setAttributeNS(null, 'stroke-width', '0px');
         
          svg.appendChild(document.createTextNode(str));
          return svg;
  },
 
 }
      var simdata="";
      var statusElement = document.getElementById('gnucap_scope_display_div');
      var outputtext = document.createElement("textarea");
      var gnucapWorker = new Worker("gnucap-io.js");
      var newtext = "";
      var timer=undefined;
      gnucapWorker.onmessage = function (oEvent) {
	if(simdata==""){
	  statusElement.textContent="";
	  outputtext.id="statusElement";
	  statusElement.appendChild( outputtext );
	}
	if(oEvent.data=="SIMULATION COMPLETED"){
	    var svg=graph.parsegnucap(simdata);
	    if(svg!=undefined){
	      statusElement.innerHTML="";
	      statusElement.appendChild(svg);
	    }
	    else{
		newtext+="COULD NOT PARSE OUTPUT DATA";
		updatetext();

		}
	}
	else{
	  simdata += oEvent.data;
	  newtext+=oEvent.data;
	  updatetext();
	}
      }
//limit update rate
      function updatetext(){
      	  if(timer==undefined)timer=setTimeout(function(){
			      outputtext.value+=newtext;
			      outputtext.scrollTop = outputtext.scrollHeight + outputtext.clientHeight;
			      timer=undefined;
			      newtext=""},500);
      }
      
      
      var spicenetlist= parent.webtronics.spicenetlist;
      gnucapWorker.postMessage(spicenetlist); // start the worker.

      </script>
  <!--script async type="text/javascript" src="gnucap-ugly.js" ></script-->
  </body>
</html>
