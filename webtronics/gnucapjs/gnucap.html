<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Emscripten-Generated Code</title>
    <style>
    body{
	margin: 0px;
	border:0px;
	padding:0px;
	border-width: 0px;
	background-color:#ffffff;
    }
    #gnucap_scope_display_div{
	margin: 0px;
	border:0px;
	padding:0px;
	border-width: 0px;
	background-color:#ffffff;
	overflow:auto;
	width:480px;
	height:360px;
	}
      pre {white-space: pre-wrap;}
      canvas{
      background-color:white;
      }
      </style>
    </head>
  <body>
  <div id="gnucap_scope_display_div"  >Downloading...</div>
  <script type='text/javascript'>

    var graph={
    width:640,
    height:480,
  gnucap2canvas:function(t){
  console.log(t);
  var points = [];
      try{      
	var text = t.split(/(#Time|#Freq).*\n/);
	text=text[text.length-1];
 	var plots= t.match(/(#Time|#Freq).*\n/);
 	plots=plots[0].split(/\s+/);
        var samples=text.split('\n');
        }
        catch(e){
        //graph.printerr(t);
        return;
        }
    var k=0;
    for(var i=0;i<samples.length;i++){
// if first character is not a digit skip this line
      if(samples[i].match(/^\s*\d+/)==null){
	console.log("Skipping "+samples[i]);
	continue;
      }
      var s = samples[i].match(/\S+/g);
      if(s!=null){
        points[k]=[];
        for(var j=0;j<s.length;j++){
//convert micro
          if(s[j][s[j].length-1]=='u'){
            s[j].replace('u','');
            s[j]=parseFloat(s[j])*0.000001;
          }
//convert nano
          if(s[j][s[j].length-1]=='n'){
            s[j].replace('n','');
            s[j]=parseFloat(s[j])*0.000000001;
          }
//convert pico
          if(s[j][s[j].length-1]=='p'){
            s[j].replace('p','');
            s[j]=parseFloat(s[j])*0.000000000001;
          }
//convert femto
          if(s[j][s[j].length-1]=='f'){
            s[j].replace('f','');
            s[j]=parseFloat(s[j])*0.00000000000001;
          }
          points[k][j]=parseFloat(s[j]);
        }
      }
      k++;
    }
    if(points.length<10){
      console.log("not enough points to graph");
      return;
    }
      
    colors=["red","blue","green","gold","hotpink","orange"];
    var font=20;
    var canvas=document.createElement('canvas'); 
    canvas.setAttribute("width",window.innerWidth);
    canvas.setAttribute("height",window.innerHeight);
    var ctx=canvas.getContext("2d");
/*I want to scale the graph so I can get more detailed information in it*/
    ctx.scale(window.innerWidth/graph.width,window.innerHeight/graph.height);
    ctx.fillStyle = "white";
    ctx.fillRect(0,0,graph.width,graph.height);

    var min=points[0][1];
    var max=points[0][1];
  //calculate max and min height
    for(var i=0;i<points.length;i++){
      for(var j=1;j < points[i].length;j++){
        min=Math.min(min,points[i][j]);
        max=Math.max(max,points[i][j]);
      }
    }
    if(isNaN(min)||isNaN(max))return;
    var hsize=(graph.width-font)/points.length;
    var vsize=(graph.height-(font*3))/(max-min);
    for(var sample=1;sample<points[0].length;sample++){
      ctx.beginPath();
      for(var time=0;time<points.length;time++){
        var x=parseInt(hsize*time)+font;
        var y =parseInt(vsize * (max-points[time][sample]))+font;
        if(isNaN(x)||isNaN(y)){
          console.log(samples[time]);
        }
        if(time==0){
	  ctx.moveTo(x,y);
        }
        else{
	  ctx.lineTo(x,y);
	}
      }
      ctx.strokeStyle=colors[sample-1];
      ctx.linWidth=1;
      ctx.stroke();
    }  

    //add the text
    ctx.font=font+"px Arial";
    for(var i=plots.length-2;i>0;i--){

      ctx.fillStyle = colors[i-1];
      ctx.fillText(i.toString(),0,i*(font*2));
    }
      ctx.fillStyle = "black";  //<======= here
      ctx.fillText("min="+min.toExponential()+" max="+max.toExponential(),0,graph.height-font);
      ctx.fillText("start="+points[0][0]+" stop="+points[points.length-1][0],0,graph.height);
     return canvas;

  },  
 }
      var simdata="";
      var statusElement = document.getElementById('gnucap_scope_display_div');
      var outputtext = document.createElement("pre");
      outputtext.id="gnucap_output";
      var gnucapWorker = new Worker("gnucap-io.js");
      var newtext = "";
      var timer=undefined;
      gnucapWorker.onmessage = function (oEvent) {
	if(simdata==""){
	  statusElement.textContent="";
	  statusElement.appendChild( outputtext );
	}
	if(oEvent.data=="SIMULATION COMPLETED"){
	    var canvas=graph.gnucap2canvas(simdata);
	    if(canvas!=undefined){
/*scale the image*/		
	      
/*this element should not overflow but it does so I remove scrollbars*/
	      statusElement.style.overflow="hidden";
	      statusElement.innerHTML="";
/* i want the image png so people can share them*/	 
	      statusElement.appendChild(canvas);
	    }
	    else{
		newtext+="COULD NOT PARSE OUTPUT DATA";
		updatetext();

		}
	}
	else{
	  simdata += oEvent.data;
	  newtext+=oEvent.data;
//limit update rate
      	  if(timer==undefined)timer=setTimeout(function(){
			      outputtext.innerHTML+=newtext;
			      statusElement.scrollTop = statusElement.scrollHeight + statusElement.clientHeight;
			      timer=undefined;
			      newtext=""},500);
	}
      }
      
      
      var spicenetlist= parent.webtronics.spicenetlist;
      gnucapWorker.postMessage(spicenetlist); // start the worker.

      </script>
  <!--script async type="text/javascript" src="gnucap-ugly.js" ></script-->
  </body>
</html>
